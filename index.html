<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Photonsphere Lab ECMWF Nordic Forecast Viewer</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet.TimeDimension -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-timedimension@1.1.0/dist/leaflet.timedimension.control.min.css">
  <script src="https://cdn.jsdelivr.net/npm/leaflet-timedimension@1.1.0/dist/leaflet.timedimension.min.js"></script>

  <style>
    :root{ --bg:#0b1220; --fg:#e9eef5; --muted:#9db0c7; --panel:#121a2a; --accent:#7cc0ff; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,Segoe UI,Roboto,Ubuntu,Helvetica,Arial;}
    #app{display:grid;grid-template-rows:64px 1fr;grid-template-columns:300px 1fr;grid-template-areas:'header header' 'sidebar map';height:100%;}
    header{grid-area:header;display:flex;align-items:center;justify-content:space-between;padding:10px 16px;background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,0));border-bottom:1px solid rgba(255,255,255,.08);}
    header h1{font-size:18px;margin:0;letter-spacing:.3px}
    #sidebar{grid-area:sidebar;background:var(--panel);border-right:1px solid rgba(255,255,255,.08);padding:12px;overflow:auto}
    #map{grid-area:map;position:relative}
    #map .leaflet-container,#map{width:100%;height:100%;min-height:560px}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px;margin-bottom:12px}
    label{font-weight:600;display:block;margin-bottom:6px}
    select,button{width:100%;padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:#0f172a;color:var(--fg)}
    .muted{color:var(--muted);font-size:12px}
    .row{display:flex;gap:8px}.row>*{flex:1}
    .footer-note{position:absolute;left:10px;bottom:10px;background:rgba(0,0,0,.45);padding:6px 8px;border:1px solid rgba(255,255,255,.15);border-radius:8px;font-size:12px}
    .status{position:absolute;right:10px;bottom:10px;background:rgba(0,0,0,.45);padding:6px 8px;border:1px solid rgba(255,255,255,.15);border-radius:8px;font-size:12px}
    .copyright{font-size:12px;color:var(--muted);line-height:1.35;}
  </style>
</head>
<body>
  <div id="app">
    <header>
      <h1>ECMWF Nordic Forecast Viewer <span style="font-size:11px;opacity:.8;margin-left:6px">Time animation</span></h1>
      <small class="muted" id="runLabel">latest run</small>
    </header>

    <aside id="sidebar">
      <div class="card">
        <label>Variable</label>
        <select id="varSel"></select>
        <div class="muted" style="margin-top:6px">
          2 m T, precip rate, MSLP, TCWV, net SW/LW flux, 850/500 hPa geopotential, 850 hPa wind speed.
        </div>
      </div>

      <div class="card">
        <label>Quick zoom</label>
        <div class="row">
          <button data-city="helsinki">Helsinki</button>
          <button data-city="tampere">Tampere</button>
        </div>
        <div class="row" style="margin-top:8px">
          <button data-city="oulu">Oulu</button>
          <button data-city="stockholm">Stockholm</button>
        </div>
      </div>

      <div class="card">
        <label>About</label>
        <div class="muted">
          Pre-rendered overlays from <code>tiles/latest</code> (ECMWF IFS Open Data). Time controls appear on the map.
          Data may need some time to be loaded.
        </div>
      </div>

      <div class="card">
        <div class="copyright">
          © 2025 Photonsphere Lab. Contains modified ECMWF IFS Open Data © ECMWF (2025), licensed under
          <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="noopener">CC BY 4.0</a>.
        </div>
      </div>
    </aside>

    <div id="map">
      <div class="footer-note">Contains modified ECMWF IFS Open Data (CC BY 4.0)</div>
      <div class="status" id="status">loading…</div>
    </div>
  </div>

  <script>
    const statusEl = document.getElementById('status');
    const runLabel = document.getElementById('runLabel');
    const varSel = document.getElementById('varSel');

    const VAR_LABELS = {
      msl: 'MSLP (hPa)',
      t2m: '2 m temperature (°C)',
      tp_rate: 'Precipitation rate (mm h⁻¹)',
      tcwv: 'Total column water vapour (kg m⁻²)',
      ssr_flux: 'Net shortwave flux (W m⁻²)',
      str_flux: 'Net longwave flux (W m⁻²)',
      gh500: 'Geopotential height 500 hPa (m)',
      gh850: 'Geopotential height 850 hPa (m)',
      wspd850: 'Wind speed 850 hPa (m s⁻¹)'
    };

    function setStatus(msg){ statusEl.textContent = msg; }

    async function loadManifest(){
      const res = await fetch('tiles/latest/manifest.json', {cache:'no-store'});
      if(!res.ok) throw new Error('manifest not found');
      return await res.json();
    }

    function buildTimesFrom(manifest){
      // Use ISO run if present; else current UTC hour
      let base = (manifest.run && manifest.run.includes('T')) ? new Date(manifest.run) : new Date();
      base.setUTCMinutes(0,0,0);
      const hours = manifest.steps.map(s => parseInt(s.replace('+',''),10));
      return hours.map(h => new Date(base.getTime() + h*3600*1000).toISOString());
    }

    // Cache-busted URL
    function urlFor(varKey, step, runTag){ return `tiles/latest/${varKey}_${step}.webp?v=${encodeURIComponent(runTag||'v')}`; }

    (async function init(){
      try{
        const manifest = await loadManifest();
        const [W,S,E,N] = manifest.bbox;
        const bounds = [[S, W], [N, E]];
        const steps = manifest.steps;
        const runTag = manifest.run || 'latest';

        // populate variables
        varSel.innerHTML = '';
        (manifest.vars || []).forEach(v => {
          const opt = document.createElement('option');
          opt.value = v; opt.textContent = VAR_LABELS[v] || v;
          varSel.appendChild(opt);
        });
        if (manifest.vars.includes('t2m')) varSel.value = 't2m';

        const times = buildTimesFrom(manifest);

        // map + base
        const map = L.map('map', {
          timeDimension: true,
          timeDimensionOptions: {
            times: times.join(','),
            currentTime: times[0],
            period: "PT3H"
          },
          timeDimensionControl: true,
          timeDimensionControlOptions: {
            autoPlay: false,         // don't auto-play on load
            playerOptions: {
              transitionTime: 1000,  // 1 second between frames (tune as you like)
              loop: true,            // infinite loop
              startOver: true        // when finished, next Play starts from the beginning
              }
          }
        });
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
        map.fitBounds(bounds);
        // FORCE slider to be at the start
        map.timeDimension.setCurrentTimeIndex(0);

        if (manifest.run && manifest.run.includes('T')) {
          runLabel.textContent = `Run: ${new Date(manifest.run).toISOString().replace('.000Z','Z')}`;
        }

        // quick zooms
        const cities = {
          helsinki: [60.1699, 24.9384],
          tampere: [61.4978, 23.7610],
          oulu: [65.0121, 25.4651],
          stockholm: [59.3293, 18.0686]
        };
        document.querySelectorAll('[data-city]').forEach(btn => {
          btn.addEventListener('click', () => map.setView(cities[btn.dataset.city], 8));
        });

        // Single image overlay reused for all frames
        const image = L.imageOverlay('', bounds, {opacity:0.80}).addTo(map);

        // Helper: set frame by index
        function setFrame(idx){
          const step = steps[idx];
          const v = varSel.value;
          const u = urlFor(v, step, runTag);
          image.setUrl(u);
          setStatus(`${VAR_LABELS[v]||v} — ${step} (${idx+1}/${steps.length})`);
        }

        // Force-load the first frame immediately
        setFrame(0);

        // On time tick, update frame
        const td = map.timeDimension;
        td.on('timeload', (e) => {
          const iso = new Date(e.time).toISOString();
          const idx = times.indexOf(iso);
          if (idx >= 0) setFrame(idx);
        });

        // When variable changes, keep the same time index
        varSel.addEventListener('change', () => {
          const iso = td.getCurrentTimeISO();
          const idx = times.indexOf(iso);
          setFrame(Math.max(0, idx));
        });

        setStatus(`Ready — ${steps.length} frames`);
      } catch (e){
        console.error(e);
        setStatus('Failed to initialize (check manifest & tiles).');
      }
    })();
  </script>
</body>
</html>
